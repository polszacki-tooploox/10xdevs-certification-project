name: Pull Request CI

on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - synchronize
      - reopened

jobs:
  lint:
    name: Lint Code
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode.app
      
      - name: Resolve Swift package dependencies
        run: |
          cd BrewGuide
          xcodebuild -resolvePackageDependencies -project BrewGuide.xcodeproj -scheme BrewGuide
      
      - name: Run SwiftLint
        run: |
          cd BrewGuide
          xcodebuild clean build -project BrewGuide.xcodeproj -scheme BrewGuide -destination "platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0" | xcpretty --simple --color
        env:
          NSUnbufferedIO: YES

  test-unit:
    name: Run Unit Tests
    runs-on: macos-latest
    needs: lint
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode.app
      
      - name: Resolve Swift package dependencies
        run: |
          cd BrewGuide
          xcodebuild -resolvePackageDependencies -project BrewGuide.xcodeproj -scheme BrewGuideTests
      
      - name: Run BrewGuideTests
        run: |
          cd BrewGuide
          xcodebuild test \
            -project BrewGuide.xcodeproj \
            -scheme BrewGuideTests \
            -destination "platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0" \
            -resultBundlePath TestResults/BrewGuideTests.xcresult
        env:
          NSUnbufferedIO: YES
      
      - name: Upload unit test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: unit-test-results
          path: BrewGuide/TestResults/BrewGuideTests.xcresult
          retention-days: 7

  test-ui:
    name: Run UI Tests
    runs-on: macos-latest
    needs: lint
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      
      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode.app
      
      - name: Resolve Swift package dependencies
        run: |
          cd BrewGuide
          xcodebuild -resolvePackageDependencies -project BrewGuide.xcodeproj -scheme BrewGuideUITests
      
      - name: Run BrewGuideUITests
        run: |
          cd BrewGuide
          xcodebuild test \
            -project BrewGuide.xcodeproj \
            -scheme BrewGuideUITests \
            -destination "platform=iOS Simulator,name=iPhone 17 Pro,OS=26.0" \
            -resultBundlePath TestResults/BrewGuideUITests.xcresult
        env:
          NSUnbufferedIO: YES
      
      - name: Upload UI test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: ui-test-results
          path: BrewGuide/TestResults/BrewGuideUITests.xcresult
          retention-days: 7

  status-comment:
    name: Post Status Comment
    runs-on: ubuntu-latest
    needs: [lint, test-unit, test-ui]
    if: always()
    permissions:
      pull-requests: write
    
    steps:
      - name: Check job statuses
        id: check
        run: |
          LINT_STATUS="${{ needs.lint.result }}"
          UNIT_STATUS="${{ needs.test-unit.result }}"
          UI_STATUS="${{ needs.test-ui.result }}"
          
          echo "lint_status=$LINT_STATUS" >> $GITHUB_OUTPUT
          echo "unit_status=$UNIT_STATUS" >> $GITHUB_OUTPUT
          echo "ui_status=$UI_STATUS" >> $GITHUB_OUTPUT
          
          if [ "$LINT_STATUS" == "success" ] && [ "$UNIT_STATUS" == "success" ] && [ "$UI_STATUS" == "success" ]; then
            echo "overall_status=success" >> $GITHUB_OUTPUT
          else
            echo "overall_status=failure" >> $GITHUB_OUTPUT
          fi
      
      - name: Post comment to PR
        uses: actions/github-script@v8
        with:
          script: |
            const lintStatus = '${{ steps.check.outputs.lint_status }}';
            const unitStatus = '${{ steps.check.outputs.unit_status }}';
            const uiStatus = '${{ steps.check.outputs.ui_status }}';
            const overallStatus = '${{ steps.check.outputs.overall_status }}';
            
            const statusEmoji = (status) => {
              switch(status) {
                case 'success': return 'âœ…';
                case 'failure': return 'âŒ';
                case 'cancelled': return 'âš ï¸';
                case 'skipped': return 'â­ï¸';
                default: return 'â“';
              }
            };
            
            const overallEmoji = overallStatus === 'success' ? 'ğŸ‰' : 'âš ï¸';
            const overallMessage = overallStatus === 'success' 
              ? '**All checks passed!**' 
              : '**Some checks failed**';
            
            const commentBody = `
            ## ${overallEmoji} Pull Request CI Status
            
            ${overallMessage}
            
            | Check | Status |
            |-------|--------|
            | Lint | ${statusEmoji(lintStatus)} ${lintStatus} |
            | Unit Tests | ${statusEmoji(unitStatus)} ${unitStatus} |
            | UI Tests | ${statusEmoji(uiStatus)} ${uiStatus} |
            
            ---
            *Workflow run: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });
